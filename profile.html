<!DOCTYPE html>
<!--
================================================================================
UNIMARKET - USER PROFILE PAGE (profile.html)
================================================================================
PURPOSE: Display user profile (own or other users)
FEATURES:
- View profile information (name, username, bio, picture, stats)
- View user's product listings (My Listings tab)
- View saved items (Saved tab) - owner only
- Edit profile button - owner only
- New Listing button - owner only

ACCESS CONTROL:
- Account owner: Can see Edit Profile button, Saved tab, New Listing button
- Other visitors: Can see profile read-only, no edit options
- Profile information displayed: name, username, bio, avatar, stats

PROFILE DATA SHOWN:
- Avatar (profile picture or placeholder icon if not uploaded)
- Full Name and Username
- Bio (or "No bio yet" if empty)
- Stats: Number of Listings, Number of Sales
- User's Products: List of items they're selling

TABS:
1. "My Listings" or "[Username]'s Listings" - Product grid
2. "Saved" (owner-only) - Bookmarked products

API ENDPOINTS:
- GET /api/users/{id} (get user profile data)
- GET /api/products?userId={id} (get user's products)
- GET /api/saved-items (get user's saved items - owner only)

QUERY PARAMETERS:
- userId (optional): View specific user's profile
- If not provided: View current logged-in user's profile

JAVASCRIPT LOGIC (find in this file):
- loadUserProfile(): Loads user data from API or localStorage
- Checks if current user is profile owner
- Shows/hides owner-only buttons based on ownership
- switchTab(): Toggle between Listings and Saved tabs
- Dynamic UI: Titles change ("My" vs "[Username]'s")

SECURITY:
- Redirect to login if no token and trying to edit
- Only account owner can see Saved Items tab
- Only account owner can see Edit Profile button
- Only account owner can see New Listing button
- Edit profile page requires authentication

LOCAL STORAGE:
- User data stored from login/signup
- Used to pre-fill edit profile form

RESPONSIVE DESIGN:
- Mobile: Single column layout
- Tablet: Two column layout
- Desktop: Full width with sidebar

STYLING:
- Profile header: Avatar + info + buttons
- Tabs: Toggle between listings and saved
- Product grid: Responsive grid layout
- Empty state: "No listings yet" message

NEXT STEPS FROM HERE:
- Edit Profile: Redirect to edit-profile.html
- New Listing: Redirect to sell.html
- View Saved: Show saved-items tab
- View Product: Click product to go to product-detail.html
================================================================================
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - UniMarket</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>

    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <a href="index.html" class="logo">UniMarket</a>

            <nav class="nav-links">
                <a href="products.html" class="nav-link">Shop</a>
                <a href="#" class="nav-link">About</a>
            </nav>

            <div class="search-bar">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" class="input input-pill" placeholder="Search for textbooks, electronics...">
            </div>

            <div class="user-actions">
                <a href="saved-items.html" class="btn-icon btn-ghost nav-icon">
                    <i data-lucide="bookmark"></i>
                </a>
                <a href="messages.html" class="btn-icon btn-ghost nav-icon">
                    <i data-lucide="message-square"></i>
                </a>
                <div class="profile-dropdown" style="position: relative;">
                    <button class="btn-icon btn-ghost nav-icon profile-dropdown-trigger" title="Profile">
                        <i data-lucide="user"></i>
                    </button>
                    <div class="profile-dropdown-menu">
                        <a href="profile.html" class="dropdown-item">View Profile</a>
                        <button onclick="logout()" class="dropdown-item logout-btn">Log Out</button>
                    </div>
                </div>
            </div>

            <button class="mobile-menu-btn">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="flex flex-col gap-4">
            <a href="products.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Shop</a>
            <a href="about.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">About</a>
            <hr style="border-color: var(--border); margin: 0.5rem 0;">
            <a href="sell.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Sell</a>
            <a href="messages.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Messages</a>
            <a href="saved-items.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Saved Items</a>
            <a href="profile.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0; color: var(--foreground);">Profile</a>
            <hr style="border-color: var(--border); margin: 0.5rem 0;">
            <button onclick="logout()" class="btn btn-outline" style="text-align: center; width: 100%;">Log Out</button>
        </div>
    </div>

    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar" style="background: var(--secondary); display: flex; align-items: center; justify-content: center;">
                <img id="profile-avatar-img" alt="User Avatar" style="display: none;">
                <div id="profile-avatar-placeholder" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                    <i data-lucide="user" style="width: 4rem; height: 4rem; color: var(--muted);"></i>
                </div>
            </div>

            <div class="profile-info">
                <h1 class="profile-username" id="profile-username" style="margin-bottom: 0;">Loading...</h1>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <span class="profile-stat-number" id="profile-listings-count">0</span>
                        <span class="profile-stat-label">Listings</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-number" id="profile-sales-count">0</span>
                        <span class="profile-stat-label">Sales</span>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <p id="profile-fullname" style="font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem;">Loading...</p>
                    <p id="profile-bio" style="color: var(--muted); max-width: 500px; margin: 0 auto;">No bio yet. Click "Edit Profile" to add one.</p>
                </div>
                
                <a id="edit-profile-btn" href="edit-profile.html" class="btn btn-outline hidden">
                    <i data-lucide="edit-2" style="width: 1rem; margin-right: 0.5rem;"></i>
                    Edit Profile
                </a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="profile-tabs">
            <button class="profile-tab active" onclick="switchTab('listings')" id="listings-tab">Listings</button>
            <button class="profile-tab" onclick="switchTab('saved')" id="saved-tab" class="hidden">Saved</button>
        </div>

        <!-- Tab Content: My Listings -->
        <div class="profile-tab-content" id="listings-content">
            <div class="flex justify-between items-center" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700;" id="listings-title">Listings</h2>
                <a href="sell.html" class="btn btn-primary hidden" id="new-listing-btn">
                    <i data-lucide="plus" style="width: 1rem; margin-right: 0.5rem;"></i> New Listing
                </a>
            </div>

            <div id="listings-grid" class="grid grid-cols-1 grid-cols-2 grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
                <p style="grid-column: 1 / -1; text-align: center; color: var(--muted); padding: 2rem;">No listings yet. <a href="sell.html">Create your first listing!</a></p>
            </div>

            <!-- Hidden template for product cards (for future dynamic loading) -->
            <div style="display: none;">
                <a href="product-detail.html" class="product-card" id="product-template">
                    <div class="product-image-container">
                        <img src="https://images.unsplash.com/photo-1544816155-12df9643f363?q=80&w=2000&auto=format&fit=crop"
                            alt="Product" class="product-image">
                        <button class="product-save-btn"><i data-lucide="bookmark" style="width: 1.25rem;"></i></button>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">Engineering Mechanics</h3>
                        <span class="product-price">$45.00</span>
                        <div class="product-meta">
                            <span class="meta-item"><i data-lucide="message-square" style="width: 1rem;"></i> 4</span>
                        </div>
                    </div>
                </a>

                <!-- Product 2 -->
                <a href="product-detail.html" class="product-card">
                    <div class="product-image-container">
                        <img src="https://images.unsplash.com/photo-1585336261022-680e295ce3fe?q=80&w=2000&auto=format&fit=crop"
                            alt="Product" class="product-image">
                        <button class="product-save-btn"><i data-lucide="bookmark" style="width: 1.25rem;"></i></button>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">MacBook Air M1</h3>
                        <span class="product-price">$650.00</span>
                        <div class="product-meta">
                            <span class="meta-item"><i data-lucide="message-square" style="width: 1rem;"></i> 15</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Tab Content: Saved (Hidden by default) -->
        <div class="profile-tab-content hidden" id="saved-content">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem;">Saved Items</h2>

            <div class="grid grid-cols-1 grid-cols-2 grid-cols-4 gap-6">
                <!-- Product 1 -->
                <a href="product-detail.html" class="product-card">
                    <div class="product-image-container">
                        <img src="https://images.unsplash.com/photo-1505740420928-5e560c06d30e?q=80&w=2000&auto=format&fit=crop"
                            alt="Product" class="product-image">
                        <button class="product-save-btn"><i data-lucide="bookmark" style="width: 1.25rem;"></i></button>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">Sony Headphones</h3>
                        <span class="product-price">$180.00</span>
                        <div class="product-meta">
                            <span class="meta-item"><i data-lucide="map-pin" style="width: 1rem;"></i> Student
                                Center</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="index.html" class="logo">UniMarket</a>
                    <p>The trusted marketplace for university students. Buy, sell, and connect safely on campus.</p>
                    <div class="footer-socials">
                        <a href="#" class="social-btn"><i data-lucide="twitter" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="facebook" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="instagram" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="github" style="width: 1.2rem;"></i></a>
                    </div>
                </div>

                <div class="footer-col">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="#">About</a></li>
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Works</a></li>
                        <li><a href="#">Career</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>Help</h4>
                    <ul>
                        <li><a href="#">Customer Support</a></li>
                        <li><a href="#">Delivery Details</a></li>
                        <li><a href="#">Terms & Conditions</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>FAQ</h4>
                    <ul>
                        <li><a href="#">Account</a></li>
                        <li><a href="#">Manage Deliveries</a></li>
                        <li><a href="#">Orders</a></li>
                        <li><a href="#">Payments</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>UniMarket Â© 2000-2023, All Rights Reserved</p>
                <div class="payment-methods flex gap-4">
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        // Get profile user ID from URL parameter
        function getProfileUserId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('userId') || null;
        }
        
        // Load user profile data
        function loadUserProfile() {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const profileUserId = getProfileUserId();
            
            // Determine whose profile to show
            const userId = profileUserId || (currentUser ? currentUser.id : null);
            const isOwnProfile = currentUser && userId === currentUser.id;
            
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }
            
            // Fetch profile data
            const token = localStorage.getItem('token');
            fetch(`/api/users/${userId}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            })
            .then(res => res.json())
            .then(data => {
                // Update profile display
                document.getElementById('profile-username').textContent = data.username || 'User';
                document.getElementById('profile-fullname').textContent = data.fullName || data.full_name || 'User';
                document.getElementById('profile-bio').textContent = data.bio || 'No bio yet.';
                
                if (data.avatar_url) {
                    document.getElementById('profile-avatar-img').src = data.avatar_url;
                }
                
                document.getElementById('profile-listings-count').textContent = data.listings_count || 0;
                document.getElementById('profile-sales-count').textContent = data.sales_count || 0;
                
                // Show avatar if it exists
                if (data.avatar_url) {
                    document.getElementById('profile-avatar-img').src = data.avatar_url;
                    document.getElementById('profile-avatar-img').style.display = 'block';
                    document.getElementById('profile-avatar-placeholder').style.display = 'none';
                }
                
                // OWNER-ONLY FEATURES
                if (isOwnProfile) {
                    // Show edit profile button
                    document.getElementById('edit-profile-btn').classList.remove('hidden');
                    
                    // Show saved items tab
                    document.getElementById('saved-tab').classList.remove('hidden');
                    
                    // Show new listing button
                    document.getElementById('new-listing-btn').classList.remove('hidden');
                    
                    // Update tab titles for owner
                    document.getElementById('listings-title').textContent = 'My Listings';
                    document.getElementById('listings-tab').textContent = 'My Listings';
                } else {
                    // Visitor viewing someone else's profile
                    document.getElementById('listings-title').textContent = `${data.username}'s Listings`;
                    document.getElementById('listings-tab').textContent = 'Listings';
                }
            })
            .catch(err => {
                console.log('Could not load profile data');
                // Fall back to localStorage if backend unavailable
                if (currentUser && isOwnProfile) {
                    document.getElementById('profile-username').textContent = currentUser.username || 'User';
                    document.getElementById('profile-fullname').textContent = currentUser.name || 'Your Name';
                    document.getElementById('edit-profile-btn').classList.remove('hidden');
                    document.getElementById('saved-tab').classList.remove('hidden');
                    document.getElementById('new-listing-btn').classList.remove('hidden');
                }
            });
        }
        
        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        // Load profile when page loads
        loadUserProfile();
    </script>
</body>

</html>