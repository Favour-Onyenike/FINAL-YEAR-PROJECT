<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Profile - UniMarket</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
</head>

<body>

    <!--
================================================================================
UNIMARKET - USER PROFILE PAGE (profile.html)
================================================================================

PURPOSE:
Display user profile information and their product listings. Supports viewing
your own profile with edit capabilities or viewing other users' profiles.

WHAT THIS PAGE DOES:
1. Shows user's profile information (avatar, name, username, bio)
2. Displays user statistics (number of listings, number of sales)
3. Shows user's product listings in a grid
4. Shows saved items (wishlist) - owner only
5. Allows editing profile (owner only)
6. Allows creating new product listing (owner only)
7. Shows "Message" button to contact seller (other users only)

KEY FEATURES:
✓ Own Profile View: Edit profile, manage listings, view saved items
✓ Other User View: Read-only, can message, see their products
✓ Product Grid: Shows all products user is selling
✓ Saved Items Tab: Bookmark products for later (owner-only)
✓ User Stats: Total listings, total sales
✓ Profile Editing: Update avatar, bio, contact info
✓ Message Integration: Direct link to chat with user

ACCESS CONTROL:
- Account Owner: Can edit profile, create listings, view saved items
- Other Visitors: Read-only access, can view products and message
- Authentication: Page checks if logged in, redirects to login if not

PROFILE DATA DISPLAYED:
- Avatar (profile picture or default icon)
- Full Name
- Username
- Bio/Description
- Phone Number (if provided)
- Statistics:
  * Number of Listings (products for sale)
  * Number of Sales (completed transactions)

TABS/SECTIONS:
1. Profile Info Section (top):
   - Avatar, name, username, bio
   - Edit Profile button (owner-only)
   - Message button (others-only)
   - New Listing button (owner-only)

2. Listings Tab:
   - Shows all products user is selling
   - Grid layout (responsive)
   - Click to view product details

3. Saved Tab (owner-only):
   - Bookmarked products
   - User can manage saved items
   - Hidden from other visitors

HOW IT WORKS:
1. Page loads -> Check URL parameter ?userId=X (which user to view)
2. Check if logged in -> Redirect to login if not
3. Fetch user data via GET /api/users/{id}
4. Determine if viewing own profile or other user
5. Show/hide edit/create buttons based on ownership
6. Fetch user's products via GET /api/products?userId={id}
7. Render product grid with images and info
8. If owner: Load saved items via GET /api/saved
9. Attach event listeners for clicks, editing, etc.

API ENDPOINTS USED:
- GET /api/users/{id} - Get user profile data
- PUT /api/users/{id} - Update profile (owner only)
- GET /api/products?userId={id} - Get user's product listings
- GET /api/saved - Get saved items (owner only)
- POST /api/products - Create new listing (owner)

IMPORTANT VARIABLES:
- userId: The user ID being viewed (from URL or localStorage)
- currentUserId: Your own user ID (logged in user)
- isOwner: Boolean - are you viewing your own profile?

JAVASCRIPT SECTIONS:
1. Page initialization - Load user data
2. Profile rendering - Display user info
3. Products loading - Fetch and display listings
4. Tab switching - Toggle between Listings/Saved
5. Edit profile - Modal for updating info
6. Create listing - Navigation to create product page

STYLING:
- Responsive grid layout for products
- Mobile-first design
- Avatar styling with border-radius
- Card layout for products
- Tab styling for switching views

SECURITY:
- Only owner can edit profile
- Only owner can see saved items
- Only owner can create new listings
- Edit profile button hidden for other users
- New Listing button hidden for other users
- Message button hidden from own profile

================================================================================
-->

    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <a href="index.html" class="logo">UniMarket</a>

            <nav class="nav-links">
                <a href="products.html" class="nav-link">Shop</a>
                <a href="about.html" class="nav-link">About</a>
            </nav>

            <div class="search-bar">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" class="input input-pill" placeholder="Search for textbooks, electronics...">
            </div>

            <div class="user-actions">
                <!-- Logged Out State -->
                <div id="logged-out-actions">
                    <a href="login.html" class="btn btn-ghost">Log In</a>
                    <a href="signup-select-university.html" class="btn btn-primary">Sign Up</a>
                </div>

                <!-- Logged In State -->
                <div id="logged-in-actions" class="hidden" style="display: flex; gap: 1rem; align-items: center;">
                    <a href="messages.html" class="btn-icon btn-ghost nav-icon" title="Messages">
                        <i data-lucide="message-square"></i>
                        <span class="notification-badge hidden" id="message-badge">0</span>
                    </a>
                    <a href="saved-items.html" class="btn-icon btn-ghost nav-icon" title="Saved Items">
                        <i data-lucide="bookmark"></i>
                    </a>
                    <div class="profile-dropdown" style="position: relative;">
                        <button class="btn-icon btn-ghost nav-icon profile-dropdown-trigger" title="Profile">
                            <i data-lucide="user"></i>
                        </button>
                        <div class="profile-dropdown-menu">
                            <a href="profile.html" class="dropdown-item">View Profile</a>
                            <a href="sell.html" class="dropdown-item">Make a Listing</a>
                            <button onclick="logout()" class="dropdown-item logout-btn">Log Out</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="mobile-menu-btn">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="flex flex-col gap-4">
            <!-- Logged Out State -->
            <div id="mobile-logged-out-actions">
                <a href="products.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Shop</a>
                <a href="about.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">About</a>
                <hr style="border-color: var(--border); margin: 0.5rem 0;">
                <a href="login.html" class="btn btn-ghost" style="text-align: center; width: 100%;">Log In</a>
                <a href="signup-select-university.html" class="btn btn-primary"
                    style="text-align: center; width: 100%;">Sign Up</a>
            </div>

            <!-- Logged In State -->
            <div id="mobile-logged-in-actions" class="hidden">
                <a href="products.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Shop</a>
                <a href="about.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">About</a>
                <hr style="border-color: var(--border); margin: 0.5rem 0;">
                <a href="sell.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Sell</a>
                <a href="messages.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Messages</a>
                <a href="saved-items.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Saved
                    Items</a>
                <a href="profile.html" class="nav-link"
                    style="font-size: 1.1rem; padding: 0.5rem 0; color: var(--foreground);">Profile</a>
                <hr style="border-color: var(--border); margin: 0.5rem 0;">
                <button onclick="logout()" class="btn btn-outline" style="text-align: center; width: 100%;">Log
                    Out</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar"
                style="background: var(--secondary); display: flex; align-items: center; justify-content: center;">
                <img id="profile-avatar-img" alt="User Avatar"
                    style="display: none; width: 100%; height: 100%; object-fit: cover;">
                <div id="profile-avatar-placeholder"
                    style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                    <i data-lucide="user" style="width: 4rem; height: 4rem; color: var(--muted);"></i>
                </div>
            </div>

            <div class="profile-info">
                <h1 class="profile-username" id="profile-username" style="margin-bottom: 0;">Loading...</h1>

                <div class="profile-stats">
                    <div class="profile-stat">
                        <span class="profile-stat-number" id="profile-listings-count">0</span>
                        <span class="profile-stat-label">Listings</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-number" id="profile-sales-count">0</span>
                        <span class="profile-stat-label">Sales</span>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <p id="profile-fullname" style="font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem;">
                        Loading...</p>
                    <p id="profile-bio" style="color: var(--muted); max-width: 500px; margin: 0 auto;">No bio yet. Click
                        "Edit Profile" to add one.</p>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                    <a id="edit-profile-btn" href="edit-profile.html" class="btn btn-outline hidden">
                        <i data-lucide="edit-2" style="width: 1rem; margin-right: 0.5rem;"></i>
                        Edit Profile
                    </a>
                    <button id="message-btn" class="btn btn-primary hidden">
                        <i data-lucide="message-square" style="width: 1rem; margin-right: 0.5rem;"></i>
                        Message
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="profile-tabs">
            <button class="profile-tab active" onclick="switchTab('listings')" id="listings-tab">Listings</button>
            <button class="profile-tab" onclick="switchTab('saved')" id="saved-tab" class="hidden">Saved</button>
        </div>

        <!-- Tab Content: My Listings -->
        <div class="profile-tab-content" id="listings-content">
            <div class="flex justify-between items-center" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700;" id="listings-title">Listings</h2>
                <a href="#" onclick="checkAuthAndNavigate('sell.html'); return false;" class="btn btn-primary hidden"
                    id="new-listing-btn">
                    <i data-lucide="plus" style="width: 1rem; margin-right: 0.5rem;"></i> New Listing
                </a>
            </div>

            <div id="listings-grid" class="product-grid">
                <!-- Products will be loaded here -->
                <p style="grid-column: 1 / -1; text-align: center; color: var(--muted); padding: 2rem;">No listings yet.
                    <a href="sell.html">Create your first listing!</a></p>
            </div>

            <!-- Hidden template for product cards (for future dynamic loading) -->
            <div style="display: none;">
                <a href="product-detail.html" class="product-card" id="product-template">
                    <div class="product-image-container">
                        <img src="https://images.unsplash.com/photo-1544816155-12df9643f363?q=80&w=2000&auto=format&fit=crop"
                            alt="Product" class="product-image">
                        <button class="product-save-btn"><i data-lucide="bookmark" style="width: 1.25rem;"></i></button>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">Engineering Mechanics</h3>
                        <span class="product-price">$45.00</span>
                        <div class="product-meta">
                            <span class="meta-item"><i data-lucide="message-square" style="width: 1rem;"></i> 4</span>
                        </div>
                    </div>
                </a>

                <!-- Product 2 -->
                <a href="product-detail.html" class="product-card">
                    <div class="product-image-container">
                        <img src="https://images.unsplash.com/photo-1585336261022-680e295ce3fe?q=80&w=2000&auto=format&fit=crop"
                            alt="Product" class="product-image">
                        <button class="product-save-btn"><i data-lucide="bookmark" style="width: 1.25rem;"></i></button>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">MacBook Air M1</h3>
                        <span class="product-price">$650.00</span>
                        <div class="product-meta">
                            <span class="meta-item"><i data-lucide="message-square" style="width: 1rem;"></i> 15</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Tab Content: Saved (Hidden by default) -->
        <div class="profile-tab-content hidden" id="saved-content">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem;">Saved Items</h2>

            <div class="product-grid">
                <!-- Product 1 -->
                <a href="product-detail.html" class="product-card">
                    <div class="product-image-container">
                        <img src="https://images.unsplash.com/photo-1505740420928-5e560c06d30e?q=80&w=2000&auto=format&fit=crop"
                            alt="Product" class="product-image">
                        <button class="product-save-btn"><i data-lucide="bookmark" style="width: 1.25rem;"></i></button>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">Sony Headphones</h3>
                        <span class="product-price">$180.00</span>
                        <div class="product-meta">
                            <span class="meta-item"><i data-lucide="map-pin" style="width: 1rem;"></i> Student
                                Center</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="index.html" class="logo">UniMarket</a>
                    <p>The trusted marketplace for university students. Buy, sell, and connect safely on campus.</p>
                    <div class="footer-socials">
                        <a href="#" class="social-btn"><i data-lucide="twitter" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="facebook" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="instagram" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="github" style="width: 1.2rem;"></i></a>
                    </div>
                </div>

                <div class="footer-col">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="#">About</a></li>
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Works</a></li>
                        <li><a href="#">Career</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>Help</h4>
                    <ul>
                        <li><a href="#">Customer Support</a></li>
                        <li><a href="#">Delivery Details</a></li>
                        <li><a href="#">Terms & Conditions</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>FAQ</h4>
                    <ul>
                        <li><a href="#">Account</a></li>
                        <li><a href="#">Manage Deliveries</a></li>
                        <li><a href="#">Orders</a></li>
                        <li><a href="#">Payments</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>UniMarket © 2000-2023, All Rights Reserved</p>
                <div class="payment-methods flex gap-4">
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        // Get the backend API URL
        // In Replit, frontend is on port 5000, backend is on port 8000
        function getBackendUrl(path) {
            const currentUrl = new URL(window.location.href);
            // Replace port 5000 (frontend) with 8000 (backend)
            const backendUrl = new URL(currentUrl);
            backendUrl.port = '8000';
            backendUrl.pathname = path;
            return backendUrl.toString();
        }

        // Get profile user ID from URL parameter
        function getProfileUserId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('userId') || null;
        }

        // Load user profile data
        function loadUserProfile() {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const profileUserId = getProfileUserId();

            // Determine whose profile to show
            const userId = profileUserId || (currentUser ? currentUser.id : null);
            const isOwnProfile = currentUser && userId === currentUser.id;

            if (!userId) {
                window.location.href = 'login.html';
                return;
            }

            // Fetch profile data
            const token = localStorage.getItem('token');
            fetch(`/api/users/${userId}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            })
                .then(res => res.json())
                .then(data => {
                    // Update profile display
                    document.getElementById('profile-username').textContent = data.username || 'User';
                    document.getElementById('profile-fullname').textContent = data.fullName || data.full_name || 'User';
                    document.getElementById('profile-bio').textContent = data.bio || 'No bio yet.';

                    document.getElementById('profile-listings-count').textContent = data.listings_count || 0;
                    document.getElementById('profile-sales-count').textContent = data.sales_count || 0;

                    // Show avatar if it exists
                    if (data.profileImage) {
                        // Convert relative image path to full backend URL
                        const imageUrl = data.profileImage.startsWith('http')
                            ? data.profileImage
                            : getBackendUrl(data.profileImage);
                        document.getElementById('profile-avatar-img').src = imageUrl;
                        document.getElementById('profile-avatar-img').style.display = 'block';
                        document.getElementById('profile-avatar-placeholder').style.display = 'none';
                    }

                    // OWNER-ONLY FEATURES
                    if (isOwnProfile) {
                        // Show edit profile button
                        document.getElementById('edit-profile-btn').classList.remove('hidden');

                        // Show saved items tab
                        document.getElementById('saved-tab').classList.remove('hidden');

                        // Show new listing button
                        document.getElementById('new-listing-btn').classList.remove('hidden');

                        // Update tab titles for owner
                        document.getElementById('listings-title').textContent = 'My Listings';
                        document.getElementById('listings-tab').textContent = 'My Listings';
                    } else {
                        // Visitor viewing someone else's profile
                        document.getElementById('listings-title').textContent = `${data.username}'s Listings`;
                        document.getElementById('listings-tab').textContent = 'Listings';

                        // Show message button for other users
                        document.getElementById('message-btn').classList.remove('hidden');
                        document.getElementById('message-btn').addEventListener('click', () => {
                            window.location.href = `messages.html?userId=${userId}`;
                        });
                    }
                })
                .catch(err => {
                    console.log('Could not load profile data');
                    // Fall back to localStorage if backend unavailable
                    if (currentUser && isOwnProfile) {
                        document.getElementById('profile-username').textContent = currentUser.username || 'User';
                        document.getElementById('profile-fullname').textContent = currentUser.name || 'Your Name';
                        document.getElementById('edit-profile-btn').classList.remove('hidden');
                        document.getElementById('saved-tab').classList.remove('hidden');
                        document.getElementById('new-listing-btn').classList.remove('hidden');
                    }
                });
        }

        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Load user's product listings
        async function loadUserListings() {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const profileUserId = getProfileUserId();
            const userId = profileUserId || (currentUser ? currentUser.id : null);

            if (!userId) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/products?userId=${userId}`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) throw new Error('Failed to load listings');

                const data = await response.json();
                const products = data.products || [];  // Extract products array from pagination wrapper
                const listingsGrid = document.getElementById('listings-grid');

                if (products.length === 0) {
                    listingsGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--muted); padding: 2rem;">No listings yet. <a href="sell.html">Create your first listing!</a></p>';
                    return;
                }

                // Display products
                listingsGrid.innerHTML = products.map(product => `
                    <a href="product-detail.html?id=${product.id}" class="product-card">
                        <div class="product-image-container">
                            <img src="${getImageUrl(product.images[0]?.imageUrl || 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?q=80&w=800')}" 
                                 alt="${product.name}" 
                                 class="product-image">
                            <button class="product-save-btn" onclick="event.preventDefault(); toggleSave(${product.id})">
                                <i data-lucide="bookmark" style="width: 1.25rem;"></i>
                            </button>
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">${product.name}</h3>
                            <span class="product-price">₦${product.price.toFixed(2)}</span>
                            <div class="product-meta">
                                <span class="meta-item">
                                    <i data-lucide="tag" style="width: 1rem;"></i> 
                                    ${product.category.name}
                                </span>
                            </div>
                        </div>
                    </a>
                `).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading listings:', error);
            }
        }

        // Load profile when page loads
        loadUserProfile();
        loadUserListings();
    </script>
</body>

</html>