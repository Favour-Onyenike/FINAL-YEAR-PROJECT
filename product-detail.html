<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Mechanics - UniMarket</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/loader.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Socket.IO Client Library for real-time messaging -->
    <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
</head>

<body>

    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div>
            <div class="spinner"></div>
            <p class="loader-text loader-message">Loading product...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <a href="index.html" class="logo">UniMarket</a>

            <nav class="nav-links">
                <a href="products.html" class="nav-link">Shop</a>
                <a href="#" class="nav-link">About</a>
            </nav>

            <div class="search-bar">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" class="input input-pill" placeholder="Search for textbooks, electronics...">
            </div>

            <div class="user-actions">
                <!-- Logged Out State -->
                <div id="logged-out-actions">
                    <a href="login.html" class="btn btn-ghost">Log In</a>
                    <a href="signup-select-university.html" class="btn btn-primary">Sign Up</a>
                </div>
                
                <!-- Logged In State -->
                <div id="logged-in-actions" class="hidden" style="display: flex; gap: 1rem; align-items: center;">
                    <a href="messages.html" class="btn-icon btn-ghost nav-icon" title="Messages">
                        <i data-lucide="message-square"></i>
                        <span class="notification-badge hidden" id="message-badge">0</span>
                    </a>
                    <a href="saved-items.html" class="btn-icon btn-ghost nav-icon" title="Saved Items">
                        <i data-lucide="bookmark"></i>
                    </a>
                    <div class="profile-dropdown" style="position: relative;">
                        <button class="btn-icon btn-ghost nav-icon profile-dropdown-trigger" title="Profile">
                            <i data-lucide="user"></i>
                        </button>
                        <div class="profile-dropdown-menu">
                            <a href="profile.html" class="dropdown-item">View Profile</a>
                            <a href="sell.html" class="dropdown-item">Make a Listing</a>
                            <button onclick="logout()" class="dropdown-item logout-btn">Log Out</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="mobile-menu-btn">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="flex flex-col gap-4">
            <!-- Logged Out State -->
            <div id="mobile-logged-out-actions">
                <a href="products.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Shop</a>
                <a href="about.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">About</a>
                <hr style="border-color: var(--border); margin: 0.5rem 0;">
                <a href="login.html" class="btn btn-ghost" style="text-align: center; width: 100%;">Log In</a>
                <a href="signup-select-university.html" class="btn btn-primary" style="text-align: center; width: 100%;">Sign Up</a>
            </div>
            
            <!-- Logged In State -->
            <div id="mobile-logged-in-actions" class="hidden">
                <a href="products.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Shop</a>
                <a href="about.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">About</a>
                <hr style="border-color: var(--border); margin: 0.5rem 0;">
                <a href="sell.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Sell</a>
                <a href="messages.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Messages</a>
                <a href="saved-items.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Saved Items</a>
                <a href="profile.html" class="nav-link" style="font-size: 1.1rem; padding: 0.5rem 0;">Profile</a>
                <hr style="border-color: var(--border); margin: 0.5rem 0;">
                <button onclick="logout()" class="btn btn-outline" style="text-align: center; width: 100%;">Log Out</button>
            </div>
        </div>
    </div>

    <div class="container product-detail-layout">

        <!-- Left Column: Gallery -->
        <div class="gallery-container">
            <div class="main-image">
                <img src="" alt="Product Image" id="main-img" style="background: var(--secondary); min-height: 400px;">
            </div>
            <div class="gallery-thumbnails" id="gallery-thumbnails">
                <!-- Thumbnails will be loaded dynamically -->
            </div>
        </div>

        <!-- Right Column: Details -->
        <div class="product-detail-info">
            <button onclick="window.history.back()" class="btn-back" style="background: none; border: none; padding: 0; cursor: pointer; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--foreground); font-size: 1rem;">
                <i data-lucide="arrow-left" style="width: 1.2rem; height: 1.2rem;"></i>
                <span>Back</span>
            </button>
            <div>
                <span class="detail-category">Loading...</span>
                <h1 class="detail-title">Loading product...</h1>
            </div>

            <div class="detail-price">Loading...</div>

            <div class="seller-card">
                <div class="seller-avatar">
                    <img src="" alt="Seller" style="background: var(--secondary);">
                </div>
                <div class="seller-info">
                    <h4>Loading seller info...</h4>
                    <div class="seller-rating" style="display: none;">
                        <i data-lucide="star" style="width: 1rem; fill: #fbbf24; color: #fbbf24;"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                <a href="messages.html" class="btn btn-outline" style="margin-left: auto;">Contact</a>
            </div>

            <div class="detail-description">
                <h3>Description</h3>
                <p>Loading product description...</p>
            </div>

            <div class="detail-actions">
                <a href="#" id="view-profile-btn" class="btn btn-primary flex-1" style="text-decoration: none; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="user" style="width: 1.2rem; margin-right: 0.5rem;"></i> View Profile
                </a>
                <button id="save-btn" class="btn btn-outline" title="Save item">
                    <i data-lucide="bookmark" style="width: 1.2rem;"></i>
                </button>
            </div>

            <!-- Owner Controls (Hidden by default, show if owner) -->
            <div class="detail-actions hidden" id="owner-controls">
                <a href="edit-product.html" class="btn btn-outline flex-1">Edit Listing</a>
                <button class="btn btn-outline"
                    style="color: var(--destructive); border-color: var(--destructive);">Delete</button>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="container comments-section">
        <h3 style="font-size: 1.5rem; font-weight: 700;">Comments <span id="comment-count">(0)</span></h3>

        <div class="comment-list" id="comment-list">
            <!-- Comments will be loaded here by JavaScript -->
        </div>

        <!-- Comment Form (Hidden if not logged in) -->
        <div class="comment-form" id="comment-form">
            <textarea class="comment-input" id="comment-input" placeholder="Ask a question..."></textarea>
            <button class="btn btn-primary btn-icon comment-submit" id="comment-submit-btn">
                <i data-lucide="send" style="width: 1rem;"></i>
            </button>
        </div>
        
        <!-- Login Prompt (Shown if not logged in) -->
        <div id="comment-login-prompt" style="display: none; padding: 1.5rem; background: var(--secondary); border-radius: 8px; text-align: center;">
            <p style="margin-bottom: 1rem;">Sign in to leave a comment</p>
            <a href="login.html?returnTo=product-detail.html" class="btn btn-primary">Sign In</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="index.html" class="logo">UniMarket</a>
                    <p>The trusted marketplace for university students. Buy, sell, and connect safely on campus.</p>
                    <div class="footer-socials">
                        <a href="#" class="social-btn"><i data-lucide="twitter" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="facebook" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="instagram" style="width: 1.2rem;"></i></a>
                        <a href="#" class="social-btn"><i data-lucide="github" style="width: 1.2rem;"></i></a>
                    </div>
                </div>

                <div class="footer-col">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="#">About</a></li>
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Works</a></li>
                        <li><a href="#">Career</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>Help</h4>
                    <ul>
                        <li><a href="#">Customer Support</a></li>
                        <li><a href="#">Delivery Details</a></li>
                        <li><a href="#">Terms & Conditions</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>FAQ</h4>
                    <ul>
                        <li><a href="#">Account</a></li>
                        <li><a href="#">Manage Deliveries</a></li>
                        <li><a href="#">Orders</a></li>
                        <li><a href="#">Payments</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>UniMarket © 2000-2023, All Rights Reserved</p>
                <div class="payment-methods flex gap-4">
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 25px; background: #f0f0f0; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        // Get product ID from URL
        const productId = new URLSearchParams(window.location.search).get('id');
        
        // Get current user info from localStorage
        function getCurrentUser() {
            const user = localStorage.getItem('user');
            return user ? JSON.parse(user) : null;
        }
        
        // Load comments from API
        async function loadComments() {
            if (!productId) return;
            
            try {
                const response = await fetch(`/api/products/${productId}/comments`);
                if (!response.ok) throw new Error('Failed to load comments');
                
                const comments = await response.json();
                renderComments(comments);
                
                // Update comment count
                document.getElementById('comment-count').textContent = `(${comments.length})`;
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }
        
        // Format date as relative time
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }
        
        // Render comments
        function renderComments(comments) {
            const commentList = document.getElementById('comment-list');
            const currentUser = getCurrentUser();
            
            if (comments.length === 0) {
                commentList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No comments yet. Be the first to ask a question!</p>';
                return;
            }
            
            commentList.innerHTML = comments.map(comment => {
                const isAuthor = currentUser && currentUser.id === comment.authorId;
                const profileImage = getImageUrl(comment.author.profileImage || 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=2000&auto=format&fit=crop');
                
                return `
                    <div class="comment-item">
                        <div class="comment-avatar">
                            <img src="${profileImage}" alt="${comment.author.fullName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        </div>
                        <div class="comment-content" style="flex: 1;">
                            <div class="comment-header">
                                <span class="comment-author">${comment.author.fullName}</span>
                                <span class="comment-date">${formatDate(comment.createdAt)}</span>
                                ${isAuthor ? `<button class="btn-delete-comment" data-comment-id="${comment.id}" style="font-size: 0.875rem; color: var(--destructive); cursor: pointer; border: none; background: none; padding: 0; margin-left: auto;">Delete</button>` : ''}
                            </div>
                            <p class="comment-text">${comment.content}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add delete event listeners
            document.querySelectorAll('.btn-delete-comment').forEach(btn => {
                btn.addEventListener('click', (e) => deleteComment(e.target.dataset.commentId));
            });
        }
        
        // Submit comment
        async function submitComment() {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                // Show login prompt
                document.getElementById('comment-form').style.display = 'none';
                document.getElementById('comment-login-prompt').style.display = 'block';
                return;
            }
            
            const content = document.getElementById('comment-input').value.trim();
            if (!content) {
                alert('Please write a comment');
                return;
            }
            
            if (!productId) {
                alert('Product not found');
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${productId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ content })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Please sign in to comment');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = `login.html?returnTo=product-detail.html?id=${productId}`;
                        return;
                    }
                    throw new Error('Failed to post comment');
                }
                
                // Clear input and reload comments
                document.getElementById('comment-input').value = '';
                loadComments();
            } catch (error) {
                console.error('Error posting comment:', error);
                alert('Failed to post comment');
            }
        }
        
        // Delete comment
        async function deleteComment(commentId) {
            if (!confirm('Delete this comment?')) return;
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Please sign in');
                        window.location.href = `login.html?returnTo=product-detail.html?id=${productId}`;
                        return;
                    }
                    throw new Error('Failed to delete comment');
                }
                
                loadComments();
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Failed to delete comment');
            }
        }
        
        // Initialize comments
        function initializeComments() {
            const currentUser = getCurrentUser();
            
            if (currentUser) {
                document.getElementById('comment-form').style.display = 'flex';
                document.getElementById('comment-login-prompt').style.display = 'none';
            } else {
                document.getElementById('comment-form').style.display = 'none';
                document.getElementById('comment-login-prompt').style.display = 'block';
            }
            
            // Add event listener to submit button
            document.getElementById('comment-submit-btn').addEventListener('click', submitComment);
            
            // Allow submitting with Ctrl+Enter or Cmd+Enter
            document.getElementById('comment-input').addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    submitComment();
                }
            });
            
            loadComments();
        }
        
        // Load product data and setup View Profile button
        async function loadProductData() {
            if (!productId) return;
            
            try {
                const response = await fetch(`/api/products/${productId}`);
                if (!response.ok) throw new Error('Failed to load product');
                
                const product = await response.json();
                const sellerId = product.seller.id;
                
                // Update product category
                document.querySelector('.detail-category').textContent = product.category.name;
                
                // Update product title
                document.querySelector('.detail-title').textContent = product.name;
                
                // Update product price
                document.querySelector('.detail-price').textContent = `₦${product.price.toFixed(2)}`;
                
                // Update product description
                const descriptionDiv = document.querySelector('.detail-description p');
                if (descriptionDiv) {
                    descriptionDiv.textContent = product.description;
                }
                
                // Update seller info
                const sellerCard = document.querySelector('.seller-card');
                if (sellerCard) {
                    const sellerAvatarImg = sellerCard.querySelector('.seller-avatar img');
                    const sellerNameH4 = sellerCard.querySelector('.seller-info h4');
                    
                    if (sellerAvatarImg) {
                        sellerAvatarImg.src = getImageUrl(product.seller.profileImage || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=2000&auto=format&fit=crop');
                    }
                    if (sellerNameH4) {
                        sellerNameH4.textContent = `Sold by ${product.seller.fullName}`;
                    }
                }
                
                // Update product images
                if (product.images && product.images.length > 0) {
                    // Update main image (use first image)
                    const mainImg = document.getElementById('main-img');
                    if (mainImg) {
                        mainImg.src = getImageUrl(product.images[0].imageUrl);
                    }
                    
                    // Update thumbnails
                    const galleryThumbnails = document.getElementById('gallery-thumbnails');
                    if (galleryThumbnails) {
                        galleryThumbnails.innerHTML = product.images.map((img, index) => `
                            <div class="thumbnail ${index === 0 ? 'active' : ''}" onclick="changeImage(this.querySelector('img').src)">
                                <img src="${getImageUrl(img.imageUrl)}" alt="Thumbnail ${index + 1}">
                            </div>
                        `).join('');
                    }
                }
                
                // Set up View Profile button
                const viewProfileBtn = document.getElementById('view-profile-btn');
                if (viewProfileBtn) {
                    viewProfileBtn.href = `profile.html?userId=${sellerId}`;
                }
                
                // Update page title
                document.title = `${product.name} - UniMarket`;
                
                // Check if product is already saved by current user
                checkIfSaved();
            } catch (error) {
                console.error('Error loading product data:', error);
            }
        }
        
        // Check if product is already saved
        async function checkIfSaved() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/saved-items', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) return;
                
                const savedItems = await response.json();
                const isSaved = savedItems.some(item => item.id === parseInt(productId));
                
                // Update button appearance
                updateSaveButton(isSaved);
            } catch (error) {
                console.error('Error checking saved items:', error);
            }
        }
        
        // Update save button appearance
        function updateSaveButton(isSaved) {
            const saveBtn = document.getElementById('save-btn');
            if (!saveBtn) return;
            
            if (isSaved) {
                saveBtn.classList.add('saved');
                saveBtn.style.color = '#ef4444';
                saveBtn.style.borderColor = '#ef4444';
                saveBtn.querySelector('i')?.setAttribute('data-lucide', 'bookmark');
            } else {
                saveBtn.classList.remove('saved');
                saveBtn.style.color = '';
                saveBtn.style.borderColor = '';
                saveBtn.querySelector('i')?.setAttribute('data-lucide', 'bookmark');
            }
            // Refresh Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }
        
        // Handle save button click
        async function toggleSaveItem() {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                alert('Please sign in to save items');
                window.location.href = `login.html?returnTo=product-detail.html?id=${productId}`;
                return;
            }
            
            if (!productId) {
                alert('Product not found');
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/saved-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ productId: parseInt(productId) })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save item');
                }
                
                const result = await response.json();
                const isSaved = result.isSaved;
                
                // Update button appearance
                updateSaveButton(isSaved);
                
                // Show feedback message
                const message = isSaved ? '✓ Item saved!' : '✗ Item removed from saved';
                showNotification(message, isSaved ? 'success' : 'info');
            } catch (error) {
                console.error('Error saving item:', error);
                showNotification('Failed to save item', 'error');
            } finally {
                saveBtn.disabled = false;
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 9999;
                font-weight: 500;
                animation: slideIn 0.3s ease-in-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Hide loader when page is fully loaded
        window.addEventListener('load', () => {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.classList.add('hidden');
            }
            
            // Add click handler to save button
            const saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', toggleSaveItem);
            }
            
            loadProductData();
            initializeComments();
        });
        
        // Simple gallery script
        function changeImage(src) {
            document.getElementById('main-img').src = getImageUrl(src);
            // Update active class on thumbnails
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
                if (thumb.querySelector('img').src === src) {
                    thumb.classList.add('active');
                }
            });
        }
    </script>
</body>

</html>